name: Security Scanning

on:
  push:
    branches: [main, master, 'claude/**']
  pull_request:
    branches: [main, master]
  schedule:
    - cron: "0 6 * * 1"  # Weekly on Monday at 06:00 UTC

permissions:
  contents: read
  security-events: write

jobs:
  pip-audit:
    name: Python Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-audit-${{ hashFiles('pyproject.toml') }}
          restore-keys: pip-audit-

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit
        run: pip-audit --strict --desc on

  gitleaks:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      matrix:
        language: [python]
    steps:
      - uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          upload: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}

  trivy:
    name: Container Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for scanning
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: hermes:scan

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: hermes:scan
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
        with:
          sarif_file: trivy-results.sarif

  bandit:
    name: Python Security Linter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install bandit
        run: pip install bandit

      - name: Run bandit gating scan (new HIGH findings)
        run: |
          bandit \
            -r server/ \
            --severity-level high \
            --confidence-level high \
            --baseline .github/security/bandit-baseline.json \
            -f json \
            -o bandit-gating-results.json

      - name: Run bandit inventory scan for reporting
        if: always()
        run: |
          bandit \
            -r server/ \
            --confidence-level low \
            -f json \
            -o bandit-results.json \
            --exit-zero

      - name: Publish bandit workflow summary
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          results_path = Path("bandit-results.json")
          if not results_path.exists():
              Path(os.environ["GITHUB_STEP_SUMMARY"]).write_text(
                  "## Bandit summary\n\nNo results file was generated.\n"
              )
              raise SystemExit(0)

          data = json.loads(results_path.read_text())
          counts = {"HIGH": 0, "MEDIUM": 0, "LOW": 0, "UNDEFINED": 0}

          for finding in data.get("results", []):
              sev = str(finding.get("issue_severity", "UNDEFINED")).upper()
              counts[sev] = counts.get(sev, 0) + 1

          run_url = f"{os.environ['GITHUB_SERVER_URL']}/{os.environ['GITHUB_REPOSITORY']}/actions/runs/{os.environ['GITHUB_RUN_ID']}"

          summary = [
              "## Bandit summary",
              "",
              "| Severity | Count |",
              "| --- | ---: |",
              f"| HIGH | {counts.get('HIGH', 0)} |",
              f"| MEDIUM | {counts.get('MEDIUM', 0)} |",
              f"| LOW | {counts.get('LOW', 0)} |",
              f"| UNDEFINED | {counts.get('UNDEFINED', 0)} |",
              "",
              "Gate policy: fail on HIGH severity + HIGH confidence findings not present in baseline.",
              "",
              f"Artifacts: [bandit-results]({run_url}) and [bandit-gating-results]({run_url}).",
          ]

          with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as fh:
              fh.write("\n".join(summary) + "\n")
          PY

      - name: Upload bandit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-results
          path: |
            bandit-results.json
            bandit-gating-results.json
            .github/security/bandit-baseline.json
            .github/security/bandit-burndown-plan.md
          retention-days: 30
